<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ç§Ÿå·åŠ©æ‰‹ï¼ˆä¸€é”®è‡ªåŠ¨å¡«è¡¨ï¼‰</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
    <div class="header">
        <h2>ğŸš€ æ•°æ®å½•å…¥</h2>
        <button class="settings-btn" onclick="openSettings()">âš™ï¸</button>
    </div>
    
    <div class="tip">ğŸ’¡ åœ¨æ­¤å¤„ Ctrl+V ç²˜è´´å®¢æˆ·æ•°æ®å†…å®¹</div>
    <textarea id="inputText" placeholder="ç²˜è´´å†…å®¹..." autofocus></textarea>
    
    <div class="btn-box">
        <button class="main-btn" onclick="parseAndCopy()">è§£ææ•°æ®</button>
    </div>

    <div id="status">âœ… å¤åˆ¶æˆåŠŸï¼æ•°æ®å·²å¯¹é½ï¼Œè¯·å» Excel C åˆ—ç²˜è´´ã€‚</div>

    <div class="verify-section">
        <h3>ğŸ” å¿«é€ŸéªŒè¯</h3>
        <div class="verify-box-container">
            <input type="text" id="verifyBox" placeholder="ğŸ“‹" readonly>
            <p>åœ¨æ­¤æ¡†ç²˜è´´å®¢æˆ·æ•°æ®éªŒè¯ä»·æ ¼</p>
            <div id="verifyMsg"></div>
        </div>
    </div>
</div>

<!-- è®¾ç½®æ¨¡æ€æ¡† -->
<div id="settingsModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeSettings()">&times;</span>
        <h2>âš™ï¸ åˆ©æ¶¦ç‡è®¾ç½®</h2>
        <div class="profit-grid">
            <div class="profit-item">
                <label>æœ€ä½åˆ©æ¶¦ï¼ˆå…ƒï¼‰</label>
                <input type="number" id="minProfit" value="25">
            </div>
            <div class="profit-item">
                <label>æ­£å¸¸å·åˆ©æ¶¦ç‡ (â‰¤200m)</label>
                <div style="display: flex; align-items: center;">
                    <input type="number" id="normalRate" value="18" min="0" max="100" style="flex: 1;">
                    <span class="unit">%</span>
                </div>
            </div>
            <div class="profit-item">
                <label>å¤§é¢å·åˆ©æ¶¦ç‡ (201-300m)</label>
                <div style="display: flex; align-items: center;">
                    <input type="number" id="largeRate" value="12" min="0" max="100" style="flex: 1;">
                    <span class="unit">%</span>
                </div>
            </div>
            <div class="profit-item">
                <label>è¶…å¤§é¢åˆ©æ¶¦ç‡ (301-500m)</label>
                <div style="display: flex; align-items: center;">
                    <input type="number" id="extraLargeRate" value="10" min="0" max="100" style="flex: 1;">
                    <span class="unit">%</span>
                </div>
            </div>
            <div class="profit-item">
                <label>å·¨å¤§é¢åˆ©æ¶¦ç‡ (>500m)</label>
                <div style="display: flex; align-items: center;">
                    <input type="number" id="hugeRate" value="8" min="0" max="100" style="flex: 1;">
                    <span class="unit">%</span>
                </div>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="btn-save" onclick="closeSettings()">ä¿å­˜</button>
            <button class="btn-cancel" onclick="closeSettings()">å…³é—­</button>
        </div>
    </div>
</div>

<script src="config.js"></script>
<script>
function openSettings() {
    document.getElementById('settingsModal').style.display = 'block';
}

function closeSettings() {
    document.getElementById('settingsModal').style.display = 'none';
}

window.onclick = function(event) {
    const modal = document.getElementById('settingsModal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
}

async function parseAndCopy() {
    const PROFIT_CONFIG = {
        minProfit: parseFloat(document.getElementById('minProfit').value) || 20,
        normalRate: (parseFloat(document.getElementById('normalRate').value) || 16) / 100,
        largeRate: (parseFloat(document.getElementById('largeRate').value) || 12) / 100,
        extraLargeRate: (parseFloat(document.getElementById('extraLargeRate').value) || 8) / 100,
        hugeRate: (parseFloat(document.getElementById('hugeRate').value) || 5) / 100
    };
    
    const inputBox = document.getElementById('inputText');
    const text = inputBox.value;
    
    if (!text.trim()) { alert("å†…å®¹ä¸ºç©ºï¼"); return; }

    const data = {};
    const patterns = {
        'çº¯å¸': /å“ˆå¤«å¸çº¯å¸:\s*([\d\.]+[mM]?)/,
        'æ®µä½': /æ®µä½:\s*([^\n]+)/,
        'KD': /ç»å¯†KD:\s*([\d\.]+)/,
        'ç­‰çº§': /ç­‰çº§:\s*(\d+)/,
        'ä¿é™©': /ä¿é™©æ ¼æ•°:\s*(\d+)/,
        'ä½“éªŒå¡': /9æ ¼ä¿é™©ä½“éªŒå¡:\s*(\d+)/,
        'ä½“åŠ›': /ä½“åŠ›:\s*(\d+)/,
        'è´Ÿé‡': /è´Ÿé‡:\s*(\d+)/,
        'AW': /AWMå­å¼¹æ•°é‡:\s*(\d+)/,
        'å…­å¤´': /6å¤´æ•°é‡:\s*(\d+)/,
        'å…­ç”²': /6ç”²æ•°é‡:\s*(\d+)/,
        'åˆ€çš®': /åˆ€çš®:\s*(.*?)(?:\n|$)/,
        'çº¢çš®': /å¹²å‘˜çº¢çš®:\s*(.*?)(?:\n|$)/,
        'é‡‘çš®': /å¹²å‘˜é‡‘çš®:\s*(.*?)(?:\n|$)/,
        'æ­¦å™¨çš®è‚¤': /æ­¦å™¨çš®è‚¤:\s*(.*?)(?:\n|$)/,
        'ä¸Šå·æ–¹å¼': /ä¸Šå·æ–¹å¼:\s*(.*?)(?:\n|$)/,
        'è”ç³»å·ç ': /è”ç³»å·ç :\s*(\d+)/,
        'ç§Ÿé‡‘': /å›æ”¶ç§Ÿé‡‘:\s*([\d\.]+)/,
        'æŠ¼é‡‘': /æŠ¼é‡‘:\s*([\d\.]+)/
    };

    for (let key in patterns) {
        const match = text.match(patterns[key]);
        data[key] = (match && match[1]) ? match[1].trim() : "";
    }
    
    const fieldsToFillZero = ['AW', 'å…­å¤´', 'å…­ç”²', 'KD'];
    fieldsToFillZero.forEach(field => {
        if (!data[field] || data[field] === "") {
            data[field] = "0";
        }
    });

    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const date = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const timeStr = `${year}-${month}-${date} ${hours}:${minutes}`;

    let finalIns = data['ä¿é™©'] || "";
    const cardCount = parseInt(data['ä½“éªŒå¡']) || 0;
    if (cardCount > 0) {
        finalIns = `${finalIns} (9æ ¼ä½“éªŒå¡${cardCount}å¤©)`;
    }

    const skinList = [data['åˆ€çš®'], data['çº¢çš®'], data['é‡‘çš®'], data['æ­¦å™¨çš®è‚¤']].filter(s => s && s !== 'æ— ');
    let skinStr = skinList.join(' / ') || 'æ— ';

    let login = 'vxæ‰«ç ';
    const loginMethod = data['ä¸Šå·æ–¹å¼'];
    if (loginMethod.includes('QQæ‰«ç ')) login = 'qqæ‰«ç ';
    else if (loginMethod.includes('QQè´¦å·å¯†ç ')) login = 'qqè´¦å¯†';
    else if (loginMethod.includes('VXæ‰«ç ')) login = 'vxæ‰«ç ';

    const pureCoins = parseFloat(data['çº¯å¸'].replace(/[Mmb]/gi, '')) || 0;
    const recoveryRent = parseFloat(data['ç§Ÿé‡‘']) || 1;
    
    let targetProfitRate = PROFIT_CONFIG.normalRate;
    if (pureCoins > 500) {
        targetProfitRate = PROFIT_CONFIG.hugeRate;
    } else if (pureCoins > 300) {
        targetProfitRate = PROFIT_CONFIG.extraLargeRate;
    } else if (pureCoins > 200) {
        targetProfitRate = PROFIT_CONFIG.largeRate;
    }
    
    let handlerRent = Math.round(recoveryRent / (1 - targetProfitRate));
    let profit = handlerRent - recoveryRent;
    if (profit < PROFIT_CONFIG.minProfit) {
        profit = PROFIT_CONFIG.minProfit;
        handlerRent = recoveryRent + profit;
    }
    
    let playerRent = handlerRent;
    let playerRatio = Math.ceil(pureCoins * 100 / playerRent);
    let ownerRatio = Math.floor(pureCoins * 100 / recoveryRent);

    let suggestedDeposit = 80;
    if (recoveryRent && recoveryRent > 0) {
        suggestedDeposit = Math.ceil(recoveryRent * 0.5);
    }

    const totalAmount = playerRent + parseFloat(data['æŠ¼é‡‘']) || 0;
    const rowArray = [
        data['çº¯å¸'].replace(/M/g, 'm').replace(/b/gi, 'm'),
        data['æ®µä½'],
        data['KD'],
        data['ç­‰çº§'],
        finalIns,
        data['ä½“åŠ›'],
        data['è´Ÿé‡'],
        data['AW'],
        data['å…­å¤´'],
        data['å…­ç”²'],
        skinStr,
        login,
        playerRatio,
        playerRent,
        data['æŠ¼é‡‘'],
        totalAmount,
        ownerRatio,
        data['ç§Ÿé‡‘'],
        profit,
        timeStr,
        data['è”ç³»å·ç '].replace(/\D/g, '')
    ];

    const finalString = rowArray.join('\t');
    await navigator.clipboard.writeText(finalString);
    document.getElementById('status').style.display = 'block';
    setTimeout(() => { document.getElementById('status').style.display = 'none'; }, 3000);
}


document.getElementById("verifyBox").addEventListener("paste", function(e) {
    e.preventDefault();
    const text = (e.clipboardData || window.clipboardData).getData("text");
    const box = document.getElementById("verifyBox");
    const msgBox = document.getElementById("verifyMsg");
    const errors = [];
    
    const fieldMap = {
       'å“ˆå¤«å¸çº¯å¸': 'hafuCoin',
       'å“ˆå¤«å¸': 'hafuCoin',
       'ç­‰çº§': 'level',
       'ä¿é™©æ ¼æ•°': 'insurance',
       'ä¿é™©': 'insurance',
       'ä½“åŠ›': 'stamina',
       'è´Ÿé‡': 'weight',
       '9æ ¼ä¿é™©ä½“éªŒå¡': 'insuranceCards',
       'ä½“éªŒå¡': 'insuranceCards',
       'åˆ€çš®': 'knifeSkins',
       'æ­¦å™¨çš®è‚¤': 'weaponSkins',
       'å›æ”¶ç§Ÿé‡‘': 'customerPrice'
    };
    
    const data = {};
    const lines = text.split('\n');
    lines.forEach(line => {
       line = line.trim();
       if (!line) return;
       const colonIdx = line.indexOf(':') !== -1 ? line.indexOf(':') : line.indexOf('ï¼š');
       if (colonIdx === -1) return;
       const field = line.substring(0, colonIdx).trim();
       let value = line.substring(colonIdx + 1).trim();
       if (!value || value === 'æ— ' || value === '-') return;
       
       const key = fieldMap[field];
       if (!key) return;
       
       if (key === 'customerPrice') {
          data[key] = parseFloat(value.replace(/[^\d.]/g, ''));
       } else if (key === 'knifeSkins' || key === 'weaponSkins') {
          data[key] = value.split(/[ã€,ï¼Œ]/).map(s => s.trim()).filter(s => s && s !== 'æ— ');
       } else if (key === 'hafuCoin') {
          data[key] = parseFloat(value.replace(/[mM]/g, ''));
       } else {
          data[key] = parseInt(value.replace(/[^\d]/g, '')) || 0;
       }
    });
    
    const customerPrice = data.customerPrice || 0;
    const hafuCoin = data.hafuCoin || 0;
    const level = data.level || 0;
    const insurance = data.insurance || 2;
    const stamina = data.stamina || 1;
    const weight = data.weight || 1;
    const insuranceCards = data.insuranceCards || 0;
    const knifeSkins = data.knifeSkins || [];
    const weaponSkins = data.weaponSkins || [];
    
    if (!hafuCoin) errors.push("ç¼ºå°‘æ•°æ®ï¼šå“ˆå¤«å¸çº¯å¸");
    if (!level) errors.push("ç¼ºå°‘æ•°æ®ï¼šç­‰çº§");
    if (!customerPrice) errors.push("ç¼ºå°‘æ•°æ®ï¼šå›æ”¶ç§Ÿé‡‘");
    
    const params = {
       hafu_coin: hafuCoin,
       level: level,
       insurance: insurance,
       stamina: stamina,
       weight: weight,
       knife_skins: knifeSkins,
       weapon_skins: weaponSkins,
       insurance_cards: insuranceCards
    };
    const ourPrice = calcRentPrice(CFG, params);
    const priceDiff = Math.abs(customerPrice - ourPrice);
    
    if (errors.length > 0) {
       box.value = "âŒ";
       box.style.color = "#dc3545";
       msgBox.innerHTML = "âŒ " + errors.map(e => `<b>${e}</b>`).join("<br>");
       msgBox.style.display = "block";
       setTimeout(() => { box.value = "ğŸ“‹"; box.style.color = "inherit"; msgBox.style.display = "none"; }, 3000);
    } else if (priceDiff < 1.5) {
       box.value = "âœ…";
       box.style.color = "#28a745";
       msgBox.style.display = "none";
       document.getElementById("inputText").value = "";
       setTimeout(() => { box.value = "ğŸ“‹"; box.style.color = "inherit"; }, 2000);
    } else {
       box.value = "âŒ";
       box.style.color = "#dc3545";
       msgBox.innerHTML = `âŒ <b>ä»·æ ¼ä¸å¯¹</b><br>å®¢æˆ·æŠ¥ä»·: ${customerPrice}å…ƒ<br>ç³»ç»Ÿè®¡ç®—: ${ourPrice}å…ƒ<br>å·®å¼‚: ${priceDiff.toFixed(1)}å…ƒ`;
       msgBox.style.display = "block";
       setTimeout(() => { box.value = "ğŸ“‹"; box.style.color = "inherit"; msgBox.style.display = "none"; }, 3000);
    }
});

document.getElementById("verifyBox").addEventListener("click", function() {
   this.focus();
});
</script>
</body>
</html>