<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ç§Ÿå·åŠ©æ‰‹ï¼ˆä¸€é”®è‡ªåŠ¨å¡«è¡¨ï¼‰</title>
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; padding: 20px; background: #f4f4f9; color: #333; }
        .container { max-width: 700px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h2 { color: #d93025; text-align: center; margin-bottom: 10px; }
        .tip { background: #fff3cd; color: #856404; padding: 12px; border-radius: 8px; font-size: 13px; margin-bottom: 20px; border: 1px solid #ffeeba; line-height: 1.6; }
        textarea { width: 100%; height: 120px; margin-bottom: 20px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 14px; outline: none; }
        .btn-box { text-align: center; }
        button { background: #d93025; color: white; border: none; padding: 15px 50px; cursor: pointer; border-radius: 50px; font-size: 18px; font-weight: bold; transition: 0.3s; }
        button:hover { background: #b0261b; transform: translateY(-2px); }
        #status { margin-top: 20px; padding: 15px; border-radius: 8px; text-align: center; display: none; font-weight: bold; background: #d4edda; color: #155724; }
    </style>
</head>
<body>
<div class="container">
    <h2>ğŸš€ æ•°æ®å½•å…¥</h2>
    <div class="tip">
        1. <b>é¡ºåºï¼š</b> çº¯å¸-æ®µä½-ç»å¯†KD-ç­‰çº§-ä¿é™©-ä½“åŠ›-è´Ÿé‡-AW-å¤´-ç”²-çš®è‚¤-ç™»å½•-æ‰“æ‰‹æ¯”ä¾‹-0-æŠ¼é‡‘-å»ºè®®æŠ¼é‡‘-å·ä¸»æ¯”ä¾‹-å›æ”¶ç§Ÿé‡‘-0-0-ç”µè¯-æ—¶é—´ã€‚<br>
        2. <b>æ“ä½œï¼š</b> åœ¨æ–‡æœ¬æ¡†ä¸­ <b>Ctrl+V</b> ç²˜è´´å†…å®¹ï¼Œå¯ä¿®æ”¹ï¼Œå†ç‚¹å‡»"è§£ææ•°æ®"ï¼Œç„¶åå» Excel <b>D åˆ—</b> ç›´æ¥ <b>Ctrl+V</b>ã€‚
    </div>
    
    <textarea id="inputText" placeholder="åœ¨æ­¤å¤„ Ctrl+V ç²˜è´´å†…å®¹..." autofocus></textarea>
    
    <div class="btn-box">
        <button onclick="parseAndCopy()">è§£ææ•°æ®</button>
    </div>

    <div id="status">âœ… å¤åˆ¶æˆåŠŸï¼æ•°æ®å·²å¯¹é½ï¼Œè¯·å» Excel C åˆ—ç²˜è´´ã€‚</div>

    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd;">
        <h3 style="color: #d93025; margin-bottom: 15px;">ğŸ” å¿«é€Ÿç²˜è´´éªŒè¯</h3>
        <div style="text-align: center;">
            <input type="text" id="verifyBox" style="
                width: 80px;
                height: 80px;
                margin: 0 auto;
                border: 2px solid #ddd;
                border-radius: 12px;
                font-size: 40px;
                text-align: center;
                cursor: pointer;
                transition: all 0.3s;
                background: white;
                padding: 0;
            " placeholder="ğŸ“‹" readonly>
            <p style="margin-top: 15px; color: #666; font-size: 13px;">åœ¨æ­¤æ¡†ç²˜è´´å®¢æˆ·æ•°æ®éªŒè¯ä»·æ ¼</p>
        </div>
    </div>
</div>

<script>
async function parseAndCopy() {
    const inputBox = document.getElementById('inputText');
    const text = inputBox.value;
    
    if (!text.trim()) { alert("å†…å®¹ä¸ºç©ºï¼"); return; }

    const data = {};
    console.log("åŸå§‹æ–‡æœ¬:", text);
    const patterns = {
        'çº¯å¸': /å“ˆå¤«å¸çº¯å¸:\s*([\d\.]+[mM]?)/,
        'æ®µä½': /æ®µä½:\s*([^\n]+)/,
        'KD': /ç»å¯†KD:\s*([\d\.]+)/,
        'ç­‰çº§': /ç­‰çº§:\s*(\d+)/,
        'ä¿é™©': /ä¿é™©æ ¼æ•°:\s*(\d+)/,
        'ä½“éªŒå¡': /9æ ¼ä¿é™©ä½“éªŒå¡:\s*(\d+)/,
        'ä½“åŠ›': /ä½“åŠ›:\s*(\d+)/,
        'è´Ÿé‡': /è´Ÿé‡:\s*(\d+)/,
        'AW': /AWMå­å¼¹æ•°é‡:\s*(\d+)/,
        'å…­å¤´': /6å¤´æ•°é‡:\s*(\d+)/,
        'å…­ç”²': /6ç”²æ•°é‡:\s*(\d+)/,
        'åˆ€çš®': /åˆ€çš®:\s*(.*?)(?:\n|$)/,
        'çº¢çš®': /å¹²å‘˜çº¢çš®:\s*(.*?)(?:\n|$)/,
        'é‡‘çš®': /å¹²å‘˜é‡‘çš®:\s*(.*?)(?:\n|$)/,
        'æ­¦å™¨çš®è‚¤': /æ­¦å™¨çš®è‚¤:\s*(.*?)(?:\n|$)/,
        'ä¸Šå·æ–¹å¼': /ä¸Šå·æ–¹å¼:\s*(.*?)(?:\n|$)/,
        'è”ç³»å·ç ': /è”ç³»å·ç :\s*(\d+)/,
        'ç§Ÿé‡‘': /å›æ”¶ç§Ÿé‡‘:\s*([\d\.]+)/,
        'æŠ¼é‡‘': /æŠ¼é‡‘:\s*([\d\.]+)/
    };

    for (let key in patterns) {
        const match = text.match(patterns[key]);
        data[key] = (match && match[1]) ? match[1].trim() : "";
    }
    
    // ä¸ºç©ºå€¼å­—æ®µå¡«å……é»˜è®¤å€¼
    const fieldsToFillZero = ['AW', 'å…­å¤´', 'å…­ç”²', 'KD'];
    fieldsToFillZero.forEach(field => {
        if (!data[field] || data[field] === "") {
            data[field] = field === 'KD' ? "0" : "0";
        }
    });
    console.log("æå–çš„æ•°æ®:", data);

    // --- å®æ—¶æ—¶é—´é€»è¾‘ (ç²¾ç¡®åˆ°åˆ†é’Ÿ) ---
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const date = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const timeStr = `${year}-${month}-${date} ${hours}:${minutes}`;

    // --- ä¿é™©åˆå¹¶é€»è¾‘ ---
    let finalIns = data['ä¿é™©'] || "";
    const cardCount = parseInt(data['ä½“éªŒå¡']) || 0;
    if (cardCount > 0) {
        finalIns = `${finalIns} (9æ ¼ä½“éªŒå¡${cardCount}å¤©)`;
    }

    // --- çš®è‚¤åˆå¹¶å¤„ç† ---
    const skinList = [data['åˆ€çš®'], data['çº¢çš®'], data['é‡‘çš®'], data['æ­¦å™¨çš®è‚¤']].filter(s => s && s !== 'æ— ');
    let skinStr = skinList.join(' / ') || 'æ— ';

    let login = 'vxæ‰«ç ';
    const loginMethod = data['ä¸Šå·æ–¹å¼'];
    if (loginMethod.includes('QQæ‰«ç ')) login = 'qqæ‰«ç ';
    else if (loginMethod.includes('QQè´¦å·å¯†ç ')) login = 'qqè´¦å¯†';
    else if (loginMethod.includes('VXæ‰«ç ')) login = 'vxæ‰«ç ';

    // --- è®¡ç®—å·ä¸»æ¯”ä¾‹å’Œæ‰“æ‰‹æ¯”ä¾‹ ---
    const pureCoins = parseFloat(data['çº¯å¸'].replace(/[Mmb]/gi, '')) || 0;
    const rentIncome = parseFloat(data['ç§Ÿé‡‘']) || 1;
    const ownerRatio = Math.round(pureCoins * 100 / rentIncome);
    let playerRatio = Math.round(ownerRatio * 0.84);

    // --- è®¡ç®—æ‰“æ‰‹ç§Ÿé‡‘ã€æ€»é‡‘é¢ã€åˆ©æ¶¦ ---
    let playerRent = Math.round(pureCoins * 100 / playerRatio);
    const deposit = parseFloat(data['æŠ¼é‡‘']) || 0;
    const totalAmount = playerRent + deposit;
    let profit = playerRent - rentIncome;

    // --- åˆ©æ¶¦è°ƒæ•´ï¼šå¦‚æœåˆ©æ¶¦ä¸è¶³20å…ƒï¼Œä¸‹è°ƒæ‰“æ‰‹æ¯”ä¾‹ ---
    if (profit < 20) {
        playerRatio = Math.round(pureCoins * 100 / (rentIncome + 20));
        playerRent = Math.round(pureCoins * 100 / playerRatio);
        profit = playerRent - rentIncome;
    }

    // --- è®¡ç®—å»ºè®®æŠ¼é‡‘ ---
    let suggestedDeposit = 80; // é»˜è®¤æœ€ä½80
    if (rentIncome && rentIncome > 0) {
        suggestedDeposit = Math.ceil(rentIncome * 0.5);
    }

    // --- æ–°é¡ºåº: çº¯å¸-æ®µä½-ç»å¯†KD-ç­‰çº§-ä¿é™©-ä½“åŠ›-è´Ÿé‡-AW-å¤´-ç”²-çš®è‚¤-ç™»å½•-æ‰“æ‰‹æ¯”ä¾‹-0-æŠ¼é‡‘-0-å·ä¸»æ¯”ä¾‹-å›æ”¶ç§Ÿé‡‘-0-0-ç”µè¯-æ—¶é—´ ---
    const rowArray = [
        data['çº¯å¸'].replace(/M/g, 'm').replace(/b/gi, 'm'),
        data['æ®µä½'],
        data['KD'],
        data['ç­‰çº§'],
        finalIns,
        data['ä½“åŠ›'],
        data['è´Ÿé‡'],
        data['AW'],
        data['å…­å¤´'],
        data['å…­ç”²'],
        skinStr,
        login,
        playerRatio,
        "",
        data['æŠ¼é‡‘'],
        "",
        ownerRatio,
        data['ç§Ÿé‡‘'],
        "",
        "",
        data['è”ç³»å·ç '].replace(/\D/g, ''),
        timeStr
    ];

    const finalString = rowArray.join('\t');

    await navigator.clipboard.writeText(finalString);
    document.getElementById('status').style.display = 'block';
    setTimeout(() => { document.getElementById('status').style.display = 'none'; }, 3000);
}

// å¿«é€Ÿç²˜è´´éªŒè¯åŠŸèƒ½
const CFG = {
  base9: 39,
  base6: 43,
  base24: 47,
  bonus_sta7_wgt7: 1,
  bonus_sta6_wgt6: 0.5,
  penalty_low: 1,
  bonus_chixiao: 1,
  bonus_knife_1: 0.5,
  bonus_knife_2to3: 1,
  bonus_knife_4to8: 1.5,
  bonus_all_knife: 3,
  bonus_weapon: 1,
  bonus_hafu_201to300: 1,
  bonus_hafu_301plus: 2,
  card24_1: 0.5, card24_2: 0.5, card24_3: 1.5, card24_4: 2, card24_5: 2.25, card24_6: 2.5, card24_7plus: 2.5,
  card6_1: 0.25, card6_2: 0.75, card6_3: 1.25, card6_4: 1.5, card6_5: 1.75, card6_6: 2, card6_7plus: 2.5,
};

const EXCLUDED_KNIFE = ["ç”µé”¯æƒŠé­‚", "å¤„åˆ‘è€…"];
const ALL_KNIFE_SKINS = ["æš—æ˜Ÿ", "é¾™ç‰™", "ä¿¡æ¡", "èµ¤éœ„", "æ€œæ‚¯", "å½±é”‹", "é»‘æµ·", "åŒ—ææ˜Ÿ", "ç”µé”¯æƒŠé­‚", "å¤„åˆ‘è€…"];
const SPECIAL_WEAPON_SKINS = ["M7æ£±é•œæ”»åŠ¿", "AS-Val-å·¨æµª"];

function calcRentPrice(cfg, p) {
  cfg = cfg || CFG;
  p = p || {};
  const hafuM = parseFloat(p.hafu_coin) || 0;
  if (!hafuM) return 0;
  const lv = parseInt(p.level) || 0;
  if (lv < 60) {
    const levelRatio = lv <= 30 ? 60 : lv <= 45 ? 55 : 52;
    return Math.round((hafuM * 100) / levelRatio);
  }
  const ins = parseInt(p.insurance) || 2;
  let ratio = ins === 9 ? cfg.base9 : ins === 6 ? cfg.base6 : cfg.base24;
  const sta = parseInt(p.stamina) || 1;
  const wgt = parseInt(p.weight) || 1;
  if (sta === 7 && wgt === 7) {
    ratio -= cfg.bonus_sta7_wgt7;
  } else if (sta === 6 && wgt === 6) {
    ratio -= cfg.bonus_sta6_wgt6;
  } else if (sta <= 3 || wgt <= 3) {
    ratio += cfg.penalty_low;
  }
  if (hafuM >= 301) {
    ratio += cfg.bonus_hafu_301plus;
  } else if (hafuM >= 201) {
    ratio += cfg.bonus_hafu_201to300;
  }
  const knifeSkins = p.knife_skins || [];
  const allOwned = ALL_KNIFE_SKINS.every((s) => knifeSkins.includes(s));
  if (allOwned) {
    ratio -= cfg.bonus_all_knife;
  } else {
    const hasChixiao = knifeSkins.includes("èµ¤éœ„");
    const validCount = knifeSkins.filter((s) => !EXCLUDED_KNIFE.includes(s)).length;
    let chixiaoBonus = hasChixiao ? cfg.bonus_chixiao : 0;
    let countBonus = 0;
    if (validCount === 1) countBonus = cfg.bonus_knife_1;
    else if (validCount >= 2 && validCount <= 3) countBonus = cfg.bonus_knife_2to3;
    else if (validCount >= 4 && validCount <= 8) countBonus = cfg.bonus_knife_4to8;
    ratio -= Math.max(chixiaoBonus, countBonus);
  }
  const weaponSkins = p.weapon_skins || [];
  if (weaponSkins.some((s) => SPECIAL_WEAPON_SKINS.includes(s))) {
    ratio -= cfg.bonus_weapon;
  }
  const cards = parseInt(p.insurance_cards) || 0;
  if (cards > 0 && ins !== 9) {
    let cardBonus = 0;
    if (ins === 2 || ins === 4) {
      if (cards >= 7) cardBonus = cfg.card24_7plus;
      else if (cards === 6) cardBonus = cfg.card24_6;
      else if (cards === 5) cardBonus = cfg.card24_5;
      else if (cards === 4) cardBonus = cfg.card24_4;
      else if (cards === 3) cardBonus = cfg.card24_3;
      else if (cards === 2) cardBonus = cfg.card24_2;
      else cardBonus = cfg.card24_1;
    } else if (ins === 6) {
      if (cards >= 7) cardBonus = cfg.card6_7plus;
      else if (cards === 6) cardBonus = cfg.card6_6;
      else if (cards === 5) cardBonus = cfg.card6_5;
      else if (cards === 4) cardBonus = cfg.card6_4;
      else if (cards === 3) cardBonus = cfg.card6_3;
      else if (cards === 2) cardBonus = cfg.card6_2;
      else cardBonus = cfg.card6_1;
    }
    ratio -= cardBonus;
  }
  if (ratio <= 0) ratio = 1;
  return Math.round((hafuM * 100) / ratio);
}

document.getElementById("verifyBox").addEventListener("paste", function(e) {
  e.preventDefault();
  const text = (e.clipboardData || window.clipboardData).getData("text");
  const box = document.getElementById("verifyBox");
  const priceMatch = text.match(/å›æ”¶ç§Ÿé‡‘[ï¼š:]\s*(\d+(?:\.\d+)?)\s*å…ƒ/);
  if (!priceMatch) {
    box.value = "âŒ";
    box.style.color = "#dc3545";
    setTimeout(() => { box.value = "ğŸ“‹"; box.style.color = "inherit"; }, 2000);
    return;
  }
  const customerPrice = parseFloat(priceMatch[1]);
  const extractValue = (pattern) => {
    const match = text.match(pattern);
    return match ? match[1] : null;
  };
  const hafuCoin = parseFloat(extractValue(/å“ˆå¤«å¸[çº¯å¸]*[ï¼š:]\s*(\d+(?:\.\d+)?)/)) || 0;
  const level = parseInt(extractValue(/ç­‰çº§[ï¼š:]\s*(\d+)/)) || 0;
  const insurance = parseInt(extractValue(/ä¿é™©æ ¼æ•°[ï¼š:]\s*(\d+)/)) || 2;
  const stamina = parseInt(extractValue(/ä½“åŠ›[ï¼š:]\s*(\d+)/)) || 1;
  const weight = parseInt(extractValue(/è´Ÿé‡[ï¼š:]\s*(\d+)/)) || 1;
  const insuranceCards = parseInt(extractValue(/ä½“éªŒå¡[ï¼š:]\s*(\d+)/)) || 0;
  const extractSkins = (pattern) => {
    const match = text.match(pattern);
    if (!match) return [];
    return match[1].split(/[ã€,ï¼Œ]/).map(s => s.trim()).filter(s => s && s !== 'æ— ');
  };
  const knifeSkins = extractSkins(/åˆ€çš®[ï¼š:]\s*(.+?)(?:\n|$)/);
  const weaponSkins = extractSkins(/æ­¦å™¨çš®è‚¤[ï¼š:]\s*(.+?)(?:\n|$)/);
  const params = {
    hafu_coin: hafuCoin,
    level: level,
    insurance: insurance,
    stamina: stamina,
    weight: weight,
    knife_skins: knifeSkins,
    weapon_skins: weaponSkins,
    insurance_cards: insuranceCards
  };
  const ourPrice = calcRentPrice(CFG, params);
  if (Math.abs(customerPrice - ourPrice) < 1.5) {
    box.value = "âœ…";
    box.style.color = "#28a745";
  } else {
    box.value = "âŒ";
    box.style.color = "#dc3545";
  }
  setTimeout(() => {
    box.value = "ğŸ“‹";
    box.style.color = "inherit";
  }, 2000);
});

document.getElementById("verifyBox").addEventListener("click", function() {
  this.focus();
});
</script>
</body>
</html>